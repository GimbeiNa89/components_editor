<html>
    <head>
        <title>Editor</title>
        <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
        <style>
            @import"https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap";* {
                box-sizing: border-box;
                font-family: DM Sans
            }

            html, body{
                margin: 0px;
                padding: 0px;
            }

            *{
                font-family: "DM Sans";
                font-weight: 400;
                color: rgba(0, 0, 0, 0.75);
                box-sizing: border-box;
            }
        </style>
        <link rel="stylesheet" href="./res/Editor/css/Editor.css">
        <script type="module">
            import { Editor } from "./res/Editor/Editor.js";
            import { getJsonFileFromPath } from "./res/Editor/Utils.js";

            const editor = new Editor(document.getElementById("myEditor"), "./res/components");

            const diagram = getJsonFileFromPath("./diagram.json");
            editor.loadDiagram(diagram);

            const DOCUMENT_ID = 'documento_di_produzione_987'; 
            const socket = io('http://localhost:3000');

            socket.on('connect', () => {
                console.log(`Connesso a Socket.IO con ID: ${socket.id}`);
                socket.emit('join_document', DOCUMENT_ID);
            });

            socket.on('update', (data) => {
                console.log("[Ricevuto] Modifiche da un altro collaboratore:", data);
                document.dispatchEvent(new CustomEvent(data.event, {detail: data.data}));
                editor.printDiagram();
            });

            socket.on('connect_error', (err) => {
                console.error(`Errore di connessione: ${err.message}`);
            });

            function sendLocalChange(event, data) {
                const dataToSend = {
                    docId: DOCUMENT_ID,
                    event: event,
                    data: data,
                };
                
                socket.emit('push_update', dataToSend);
                document.dispatchEvent(new CustomEvent(dataToSend.event, {detail: data}))
            }

            document.addEventListener("emit_component_add", (e) => {
                console.log("Component added: ", e.detail.config);
                editor.printDiagram();
                sendLocalChange("component_add", e.detail);
            })
            document.addEventListener("emit_connection_add", (e) => {
                console.log("Connection added: ", e.detail.config);
                editor.printDiagram();
                sendLocalChange("connection_add", e.detail);
            })

            document.addEventListener("emit_component_delete", (e) => {
                console.log("Component removed: ", e.detail.componentID);
                editor.printDiagram();
                sendLocalChange("component_delete", e.detail);
            })
            document.addEventListener("emit_connection_delete", (e) => {
                console.log("Connection removed: ", e.detail.connectionID);
                editor.printDiagram();
                sendLocalChange("connection_delete", e.detail);
            })
            document.addEventListener("emit_component_update", (e) => {
                console.log("Component updated: ", e.detail);
                editor.printDiagram();
                sendLocalChange("component_update", e.detail);
            })
            document.addEventListener("emit_connection_update", (e) => {
                console.log("Connection updated: ", e.detail);
                editor.printDiagram();
                sendLocalChange("connection_update", e.detail);
            })
        </script>
    </head>
    <body>
        <div class="Editor" id="myEditor"></div>
    </body>
</html>